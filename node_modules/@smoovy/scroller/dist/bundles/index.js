"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var utils=require("@smoovy/utils"),event=require("@smoovy/event"),ticker=require("@smoovy/ticker"),observer=require("@smoovy/observer"),tween=require("@smoovy/tween");(exports.ScrollerDomEvent||(exports.ScrollerDomEvent={})).RECALC="recalc";class ScrollerDom extends event.EventEmitter{constructor(e){super(),this.config=e,this.dynamic=!1,this.dynamic=e.element instanceof HTMLElement,!1!==e.observer&&(this.observer=new observer.ElementObserver(e.observer)),this.container=new observer.ElementState(this.dynamic?document.createElement("div"):e.element.container),this.wrapper=new observer.ElementState(this.dynamic?document.createElement("div"):e.element.wrapper),this.observer&&(this.container=this.observer.observe(this.container),this.wrapper=this.observer.observe(this.wrapper),this.wrapper.changed(()=>this.emit(exports.ScrollerDomEvent.RECALC)),this.container.changed(()=>this.emit(exports.ScrollerDomEvent.RECALC))),this.dynamic&&(this.container.element.className+="smoovy-container",this.wrapper.element.className+="smoovy-wrapper",this.container.element.appendChild(this.wrapper.element))}recalc(e=!1){this.wrapper.update(e),this.container.update(e)}attach(){if(this.dynamic){const e=this.config.element,t=Array.from(e.childNodes);e.appendChild(this.container.element),this.wrapper.element.append(...t)}}detach(){if(this.dynamic){const e=this.config.element,t=Array.from(this.wrapper.element.childNodes);e.append(...t),e.removeChild(this.container.element)}}}!function(e){e.DELTA="delta",e.OUTPUT="output",e.VIRTUAL="virtual",e.RECALC="recalc",e.TWEEN_TO="tween_to",e.SCROLL_TO="scroll_to",e.TRANSFORM_DELTA="~delta",e.TRANSFORM_VIRTUAL="~virtual",e.TRANSFORM_OUTPUT="~output"}(exports.ScrollerEvent||(exports.ScrollerEvent={}));class Scroller extends event.EventEmitter{constructor(e,t){super(),this.attached=!1,this.locks=[],this.availableBehaviors=new Map,this.attachedBehaviors=new Map,this.position={output:{x:0,y:0},virtual:{x:0,y:0}},this.dom=e instanceof ScrollerDom?e:new ScrollerDom(e instanceof HTMLElement?{element:e}:e);for(const e in t)t.hasOwnProperty(e)&&this.setBehavior(e,t[e]);this.attach()}attach(){this.attached||(this.attached=!0,this.unlisten=event.listenCompose(this.dom.on(exports.ScrollerDomEvent.RECALC,()=>{this.updateDelta({x:0,y:0}),ticker.Ticker.requestAnimationFrame(()=>this.emit(exports.ScrollerEvent.RECALC))}),this.on(exports.ScrollerEvent.DELTA,e=>{this.isLocked()||this.updateDelta(e)})),this.dom.attach(),this.availableBehaviors.forEach((e,t)=>{this.attachBehavior(t)}))}destroy(){this.attached&&(this.attached=!1,"function"==typeof this.unlisten&&(this.unlisten(),delete this.unlisten),this.dom.detach(),this.attachedBehaviors.forEach(e=>{"function"==typeof e&&e.call(this)}))}recalc(e=!1){this.dom.recalc(e),e?ticker.Ticker.requestAnimationFrame(()=>this.emit(exports.ScrollerEvent.RECALC)):this.emit(exports.ScrollerEvent.RECALC)}get behaviors(){return this.availableBehaviors}setBehavior(e,t){this.availableBehaviors.set(e,t)}deleteBehavior(e){return this.attachedBehaviors.has(e)&&this.detachBehavior(e),this.availableBehaviors.delete(e)}attachBehavior(e){const t=this.availableBehaviors.get(e);return!(!t||this.attachedBehaviors.get(e)||(this.attachedBehaviors.set(e,t(this)),0))}detachBehavior(e){const t=this.attachedBehaviors.get(e);return!!t&&(t.call(this),this.attachedBehaviors.delete(e),!0)}updateDelta(e){const t=this.position.virtual;this.emit(exports.ScrollerEvent.TRANSFORM_DELTA,e,t=>{e.x=t.x,e.y=t.y}),this.updatePosition({x:utils.isNum(e.x)?t.x-e.x:void 0,y:utils.isNum(e.y)?t.y-e.y:void 0})}updatePosition(e){e&&utils.isNum(e.x)&&(this.position.virtual.x=e.x),e&&utils.isNum(e.y)&&(this.position.virtual.y=e.y),this.emit(exports.ScrollerEvent.VIRTUAL,this.position.virtual),this.emit(exports.ScrollerEvent.TRANSFORM_VIRTUAL,this.position.virtual,e=>{this.position.virtual.x=e.x,this.position.virtual.y=e.y}),this.isEventMuted(exports.ScrollerEvent.TRANSFORM_OUTPUT)||!this.hasEventListeners(exports.ScrollerEvent.TRANSFORM_OUTPUT)?this.updateOutput(this.position.virtual):this.emit(exports.ScrollerEvent.TRANSFORM_OUTPUT,{pos:this.position.output,step:e=>this.updateOutput(e)})}updateOutput(e){this.position.output.x=e.x,this.position.output.y=e.y,this.emit(exports.ScrollerEvent.OUTPUT,e)}lock(e="default",t=!0){!this.locks.includes(e)&&t?this.locks.push(e):t||this.unlock(e)}unlock(e="default"){const t=this.locks.indexOf(e);t>-1&&this.locks.splice(t,1)}isLocked(e){return e?this.locks.includes(e):this.locks.length>0}scrollTo(e,t=!1){this.emit(exports.ScrollerEvent.SCROLL_TO,{pos:e,skipOutputTransform:t})}tweenTo(e,t={}){this.emit(exports.ScrollerEvent.TWEEN_TO,{pos:e,options:t})}onVirtual(e){return this.on(exports.ScrollerEvent.VIRTUAL,e)}onScroll(e){return this.on(exports.ScrollerEvent.OUTPUT,e)}onDelta(e){return this.on(exports.ScrollerEvent.DELTA,e)}}const behavior=(e={})=>t=>{const o=e.focusTarget||utils.Browser.client?window:void 0,i=t.dom.container.element,r=e.ignoreInside||[];return event.listenCompose(event.listenEl(i,"scroll",e=>{e.preventDefault(),i.scrollLeft=i.scrollTop=0}),o?event.listenEl(o,"focus",o=>{ticker.Ticker.requestAnimationFrame(()=>{const s=o.target;if(s instanceof HTMLElement&&(!r.map(e=>e.contains(s)).includes(!0)&&s&&i.contains(s)||i===s)){const o=s.getBoundingClientRect(),i=t.dom.container.size;if(o.top<=0||o.top>=i.height||o.left<=0||o.right>=i.width)if(e.nativeTarget){const r=t.position.virtual;e.nativeTarget.scrollTo(r.x+o.left-i.width/2,r.y+o.top-i.height/2)}else t.emit(exports.ScrollerEvent.DELTA,{y:-o.top+i.height/2,x:-o.left+i.width/2})}})},!0):void 0)};function getDeltaByKeyEvent(e,t=100,o=250,i=200,r=1/0){const s={x:0,y:0};switch(e.key){case" ":s.y=-i;break;case"ArrowLeft":s.x=t;break;case"ArrowRight":s.x=-t;break;case"ArrowDown":s.y=-t;break;case"ArrowUp":s.y=t;break;case"PageDown":s.y=-o;break;case"PageUp":s.y=o;break;case"Home":s.y=r;break;case"End":s.y=-r}return s}const defaultConfig={condition:()=>!1},behavior$1=(e={})=>{const t=Object.assign(defaultConfig,e);let o;return o=(e=>{const i=t.target||window,r=[];let s;const n=()=>({x:i===window?i.scrollX:i.scrollLeft,y:i===window?i.scrollY:i.scrollTop}),l=()=>{t.condition()?(e.behaviors.forEach((t,i)=>{t!==o&&(e.detachBehavior(i),r.push(i))}),s=event.listenCompose(event.listenEl(i,"scroll",()=>{const t=n();e.emit(exports.ScrollerEvent.DELTA,{x:e.position.virtual.x-t.x,y:e.position.virtual.y-t.y})}),e.on(exports.ScrollerEvent.SCROLL_TO,({pos:e})=>{if(utils.isNum(e.x)||utils.isNum(e.y)){const t=n();i.scrollTo(utils.isNum(e.x)?e.x:t.x,utils.isNum(e.y)?e.y:t.y)}})),e.on(exports.ScrollerEvent.TWEEN_TO,({pos:t,options:o})=>{const i=!!o.force;let r;const s=()=>{r&&!i&&(r.stop(),r=void 0)},n=event.listenCompose(event.listenEl(window,"touchstart",s),event.listenEl(window,"wheel",s),event.listenEl(window,"keydown",e=>{const t=getDeltaByKeyEvent(e);"Tab"!==e.key&&0===t.x&&0===t.y||s()}));r=tween.Tween.fromTo(e.position.virtual,t,{mutate:!1,duration:o.duration,easing:o.easing,on:{update:e=>window.scrollTo(e.x,e.y),complete:n,stop:n}})})):r.length>0&&(s&&(s(),s=void 0),r.forEach(t=>e.attachBehavior(t)),ticker.Ticker.requestAnimationFrame(()=>e.dom.recalc()))};setTimeout(()=>l()),e.on(exports.ScrollerEvent.RECALC,()=>l())})},behavior$2=()=>e=>e.on(exports.ScrollerEvent.TRANSFORM_VIRTUAL,t=>{const o=e.dom.wrapper.size,i=e.dom.container.size,r=Math.max(o.width-i.width,0),s=Math.max(o.height-i.height,0);return{x:utils.clamp(t.x,0,r),y:utils.clamp(t.y,0,s)}}),defaultConfig$1={passive:!1,target:utils.Browser.client?document.documentElement:void 0,eventName:"keydown",arrowDelta:100,pageDelta:250,spaceDelta:200,homeEndDelta:1/0},behavior$3=(e={})=>{const t=Object.assign(defaultConfig$1,e);return o=>{const i=t.target;return utils.Browser.wheelEvent?event.listenEl(i,t.eventName,e=>{const i=getDeltaByKeyEvent(e,t.arrowDelta,t.pageDelta,t.spaceDelta,t.homeEndDelta);(i.x||i.y)&&o.emit(exports.ScrollerEvent.DELTA,i)},{passive:e.passive}):void 0}},defaultConfig$2={damping:.1,precision:.009,mobileDamping:.18},behavior$4=(e={})=>{const t=Object.assign(defaultConfig$2,e);return e=>{let o;const i=t.ticker||new ticker.Ticker,r=utils.Browser.mobile?t.mobileDamping:t.damping,s=e.on(exports.ScrollerEvent.TRANSFORM_OUTPUT,({pos:s,step:n})=>{o&&o.kill(),o=i.add((o,i,l)=>{const a=e.position.virtual,c=utils.lerp(s.x,a.x,r),p=utils.lerp(s.y,a.y,r),h=Math.abs(a.x-c),v=Math.abs(a.y-p);h<t.precision&&v<t.precision&&l(),n({x:c,y:p})})});return()=>{s(),i.kill()}}},defaultConfig$3={passive:!1,multiplier:1,multiplierFirefox:25},behavior$5=(e={})=>{const t=Object.assign(defaultConfig$3,e);return o=>{const i=t.target||document.documentElement;return utils.Browser.wheelEvent?event.listenEl(i,"wheel",i=>{const r={x:0,y:0};e.passive||i.preventDefault(),r.x=i.wheelDeltaX||-1*i.deltaX,r.y=i.wheelDeltaY||-1*i.deltaY,r.x*=t.multiplier,r.y*=t.multiplier,utils.Browser.firefox&&1===i.deltaMode&&(r.x*=t.multiplierFirefox,r.y*=t.multiplierFirefox),o.emit(exports.ScrollerEvent.DELTA,r)},{passive:t.passive}):void 0}},behavior$6=(e={})=>t=>t.on(exports.ScrollerEvent.SCROLL_TO,o=>{let i;o.skipOutputTransform&&(i=t.muteEvents(exports.ScrollerEvent.TRANSFORM_OUTPUT));const r=t.position.virtual;if(e.nativeTarget){const t={};"number"==typeof o.pos.x&&(t.left=o.pos.x),"number"==typeof o.pos.y&&(t.top=o.pos.y),e.nativeTarget.scrollTo(Object.assign({behavior:e.nativeBehavior||"smooth"},t))}else{const e={};"number"==typeof o.pos.x&&(e.x=-(o.pos.x-r.x)),"number"==typeof o.pos.y&&(e.y=-(o.pos.y-r.y)),t.updateDelta(e)}ticker.Ticker.requestAnimationFrame(()=>{i&&i()})}),defaultConfig$4={defaults:{width:"100%",height:"100%",overflow:"hidden"}},behavior$7=(e={})=>{const t=utils.objectDeepMerge(defaultConfig$4,e);return e=>{const o=e.dom.container.element;for(const e in t.defaults)t.defaults.hasOwnProperty(e)&&(o.style[e]=t.defaults[e]);return()=>{for(const e in t.defaults)t.defaults.hasOwnProperty(e)&&(o.style[e]="")}}},defaultConfig$5={passive:!1,deltaMultiplier:1,velocityDamping:.08,velocityMultiplier:20,minimumThreshold:2},behavior$8=(e={})=>{const t=Object.assign(defaultConfig$5,e);return e=>{const o=document.documentElement,i=t.target||o,r=new ticker.Ticker,s={x:0,y:0},n={x:0,y:0},l=t.minimumThreshold;let a=0,c=!1;const p=e=>e.targetTouches?e.targetTouches[0]:e;return event.listenCompose(event.listenEl(i,"touchstart",e=>{r.kill();const t=p(e);s.x=t.pageX,s.y=t.pageY,c=!0},{passive:t.passive}),event.listenEl(o,"touchend",()=>{c&&(0===n.x&&0===n.y||r.add((o,i,r)=>{n.x=utils.lerp(n.x,0,t.velocityDamping),n.y=utils.lerp(n.y,0,t.velocityDamping),e.emit(exports.ScrollerEvent.DELTA,n),utils.between(n.x,l,-l)&&utils.between(n.y,l,-l)&&(n.x=0,n.y=0,r())})),c=!1},{passive:t.passive}),event.listenEl(o,"touchmove",o=>{if(c){o.preventDefault();const i={x:0,y:0},r=p(o);i.x=(r.pageX-s.x)*t.deltaMultiplier,i.y=(r.pageY-s.y)*t.deltaMultiplier;const l=ticker.Ticker.now()-a;n.x=(s.x-r.pageX)/l,n.y=(s.y-r.pageY)/l,n.x*=-1*t.velocityMultiplier,n.y*=-1*t.velocityMultiplier,s.x=r.pageX,s.y=r.pageY,a=ticker.Ticker.now(),e.emit(exports.ScrollerEvent.DELTA,i)}},{passive:t.passive}))}},defaultConfig$6={firefoxFix:!0,initialStyles:!0,precision:2},updateTransform=(e,t=0,o=0,i=!1)=>{let r=`translate3d(${-t}px, ${-o}px, 0)`;i&&(r+=" rotate3d(0.01, 0.01, 0.01, 0.01deg)"),e.style.transform=r},behavior$9=(e={})=>{const t=Object.assign(defaultConfig$6,e),o=t.firefoxFix&&utils.Browser.firefox;return e=>{const i=e.dom.wrapper.element,r=e.on(exports.ScrollerEvent.OUTPUT,e=>{const r=utils.cutDec(e.x,t.precision),s=utils.cutDec(e.y,t.precision);updateTransform(i,r,s,o)});return t.initialStyles&&updateTransform(i,0,0,o),()=>{i.style.transform="",r()}}},behavior$a=(e={})=>t=>{let o;return t.on(exports.ScrollerEvent.TWEEN_TO,({pos:i,options:r})=>{const s=!!r.force,n=event.listenCompose(void 0===e.nativeTarget?event.listenCompose(t.on(exports.ScrollerEvent.DELTA,()=>{o&&!s&&o.stop()}),t.muteEvents(exports.ScrollerEvent.TRANSFORM_OUTPUT,s&&exports.ScrollerEvent.DELTA)):event.listenEl(e.nativeTarget,e.nativeKillEvents||["wheel","touchmove"],()=>{o&&!s&&o.stop()}));o&&o.stop(),o=tween.Tween.fromTo(t.position.virtual,i,{mutate:!1,duration:r.duration,easing:r.easing,on:{update:o=>{e.nativeTarget?e.nativeTarget.scrollTo(o.x,o.y):t.updateDelta({x:t.position.virtual.x-o.x,y:t.position.virtual.y-o.y})},stop:()=>{n(),o=void 0},complete:()=>{n(),o=void 0}}})})},defaultConfig$7={target:utils.Browser.client?window:void 0},behavior$b=(e={})=>{const t=Object.assign(defaultConfig$7,e);return e=>{const o=document.createElement("div"),i=e.dom.container.element.parentElement,r=()=>{o.style.height=`${e.dom.wrapper.size.height}px`};return r(),i&&i.append(o),event.listenCompose(()=>o.remove(),t.target?event.listenEl(t.target,"scroll",()=>e.emit(exports.ScrollerEvent.DELTA,{x:e.position.virtual.x-window.scrollX,y:e.position.virtual.y-window.scrollY})):void 0,e.on(exports.ScrollerEvent.RECALC,r))}},smoothScroll=(e,t={})=>new Scroller(e,Object.assign({clampContent:behavior$2(),tweenTo:behavior$a(),scrollTo:behavior$6(),bypassFocus:behavior(t.focus),styleContainer:behavior$7({defaults:t.styles}),touchInertia:behavior$8(t.touch),lerpContent:behavior$4(t.lerp),mouseWheel:behavior$5(t.mouse),translate:behavior$9(t.translate),keyboard:behavior$3(t.keyboard)},t.behaviors||{})),nativeSmoothScroll=(e,t={})=>new Scroller(e,Object.assign({clampContent:behavior$2(),nativeScrollbar:behavior$b(t.scrollbar),lerpContent:behavior$4(t.lerp),bypassNative:behavior$1(Object.assign({condition:()=>utils.Browser.mobile},t.native)),translate:behavior$9(t.translate),tweenTo:behavior$a(Object.assign({nativeTarget:utils.Browser.client?window:void 0},t.tweenTo)),scrollTo:behavior$6(Object.assign({nativeTarget:utils.Browser.client?window:void 0},t.scrollTo)),bypassFocus:behavior(Object.assign({nativeTarget:utils.Browser.client?window:void 0},t.focus)),styleContainer:behavior$7({defaults:Object.assign({position:"fixed",left:"0px",top:"0px",width:"100%",height:"100%"},t.styles)})},t.behaviors||{}));exports.Scroller=Scroller,exports.ScrollerDom=ScrollerDom,exports.bypassFocus=behavior,exports.bypassNative=behavior$1,exports.clampContent=behavior$2,exports.keyboard=behavior$3,exports.lerpContent=behavior$4,exports.mouseWheel=behavior$5,exports.nativeScrollbar=behavior$b,exports.nativeSmoothScroll=nativeSmoothScroll,exports.scrollTo=behavior$6,exports.smoothScroll=smoothScroll,exports.styleContainer=behavior$7,exports.touchInertia=behavior$8,exports.translate=behavior$9,exports.tweenTo=behavior$a;
//# sourceMappingURL=index.js.map
